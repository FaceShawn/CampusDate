<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FreetimeController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">spring-boot-campus-date</a> &gt; <a href="index.source.html" class="el_package">com.campus.controller</a> &gt; <span class="el_source">FreetimeController.java</span></div><h1>FreetimeController.java</h1><pre class="source lang-java linenums">package com.campus.controller;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Random;

import javax.servlet.http.HttpServletRequest;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;

import com.campus.common.ConstantMsg;
import com.campus.common.utils.ErrorResponseUtil;
import com.campus.common.utils.SessionUtil;
import com.campus.common.utils.StringUtil;
import com.campus.model.Freetime;
import com.campus.model.Section;
import com.campus.model.User;
import com.campus.service.DeptService;
import com.campus.service.FreetimeService;
import com.campus.service.SectionService;
import com.campus.service.UserService;
import com.google.gson.Gson;

import groovyjarjarcommonscli.ParseException;

@Controller
@RequestMapping(value=&quot;/freetime&quot;)
<span class="nc" id="L38">public class FreetimeController {</span>

		@Autowired
	    private FreetimeService freetimeService;
		@Autowired
		private UserService userService;
		@Autowired
		private SectionService sectionService;
		
		
<span class="nc" id="L48">		User sessionUser = null;</span>

		/**
	     * 跳转到添加空闲时间页面
	     */
	    @RequestMapping(value=&quot;/add&quot; ,method = RequestMethod.GET)
	    public String addFreetime(){
<span class="nc" id="L55">	        return &quot;freetime/add&quot;;</span>
	    }
	    
	    /**
	     * 添加空闲时间
	     *
	     * @param request
	     */
	    @RequestMapping(value=&quot;/adding&quot;, method = RequestMethod.POST, produces = &quot;application/json; charset=utf-8&quot;)
	    @ResponseBody
	    public String registering(HttpServletRequest request) throws java.text.ParseException, ParseException{
	        
	    	// 获取传递过来的参数
<span class="nc" id="L68">	        String freeDate 	= request.getParameter(&quot;freeDate&quot;);</span>
<span class="nc" id="L69">	        String sectionCode	= request.getParameter(&quot;sectionCode&quot;);</span>
<span class="nc" id="L70">	        String freeNote		= request.getParameter(&quot;freeNote&quot;);</span>
<span class="nc" id="L71">	        String freeState=null;</span>
<span class="nc" id="L72">	        String reserverName=null;</span>
<span class="nc" id="L73">	        String reserverMsg=null;</span>
	        
<span class="nc" id="L75">	        String allowStr = request.getParameter(&quot;allowNum&quot;);</span>
<span class="nc bnc" id="L76" title="All 4 branches missed.">	        if(allowStr==null || !StringUtil.isNumeric(allowStr) ) {</span>
<span class="nc" id="L77">	        	allowStr = &quot;1&quot;;</span>
	        }
<span class="nc" id="L79">	        int allowNum = Integer.parseInt(allowStr);</span>
	        
//	        // 判断是否为数字
//	        int allowNum;
//	        if( StringUtil.isNumeric( request.getParameter(&quot;allowNum&quot;) ) ) {
//	        	allowNum = Integer.parseInt(request.getParameter(&quot;allowNum&quot;));
//	        }else {
//	        	allowNum = 1;
//	        }
	        
	    	// 调试时随机构造传递过来的参数
	        if(ConstantMsg.DEBUG) {
	        	System.out.println(&quot;\n\n前端提交：&quot;);
	        	System.out.println(&quot;freeDate=&quot;+freeDate+&quot;\n&quot;
	        			+&quot;sectionCode=&quot;+sectionCode);
	        	
	        	// 随机教师用户登陆
	        	Random random = new Random();
	        	int id = random.nextInt(200);
	        	List&lt;User&gt; userList = this.userService.findByUserGroup(ConstantMsg.USERGROUP_TEACHER);
	        	User user = userList.get(id % userList.size());
	        	SessionUtil.login(user, request);
	        	
	        	// 从数组中随机取一个节次
	        	String[] sectionCodeList = {&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot;,
	        								&quot;8&quot;, &quot;9&quot;, &quot;10&quot;, &quot;11&quot;};
	        	sectionCode = sectionCodeList[id % sectionCodeList.length];
	        	
	        	// 取得当前时间戳（精确到秒）
	        	long time = 1526642665;
	        	// 随机生成一个月以内的秒数
	        	long j = random.nextInt(2592000);
	        	time = time + j;
	            SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);  
	            freeDate = sdf.format(new Date(Long.valueOf(time+&quot;000&quot;)));  
	            
	            // 预约人数
	            allowNum = random.nextInt(10);
	            if(allowNum == 0) {
	            	allowNum = 1;
	            }
	            
	        	System.out.println(&quot;\ndebug自动赋值：&quot;);
	        	System.out.println(&quot;freeDate=&quot;+freeDate+&quot;\n&quot;
	        			+&quot;sectionCode=&quot;+sectionCode);
	        	System.out.println(&quot;-------------------------&quot;);
	        }else {
	        }
	       
	        // 验证用户是否已登录
<span class="nc bnc" id="L129" title="All 2 branches missed.">	        if(SessionUtil.isLogin(request)) {</span>
<span class="nc" id="L130">	        	this.sessionUser = SessionUtil.getUserFromSession(request);</span>
	        }else {
<span class="nc" id="L132">	        	return ErrorResponseUtil.setResponse(&quot;400&quot;, ConstantMsg.USER_IS_NOT_LOGIN);</span>
	        }
	        // 验证用户是否有权限操作
<span class="nc bnc" id="L135" title="All 2 branches missed.">	        if(!this.sessionUser.getUserGroup().equals(ConstantMsg.USERGROUP_TEACHER)) {</span>
<span class="nc" id="L136">	        	return ErrorResponseUtil.setResponse(&quot;400&quot;, ConstantMsg.USER_IS_NOT_PERMITTED_TO_OOPERATE);</span>
	        }
	        
	        // 验证参数是否合法
<span class="nc bnc" id="L140" title="All 2 branches missed.">	        if(StringUtil.isEmpty(freeDate)) {</span>
<span class="nc" id="L141">	            return ErrorResponseUtil.setResponse(&quot;400&quot;, ConstantMsg.FREE_DATE_IS_NULL);</span>
	        }
<span class="nc bnc" id="L143" title="All 2 branches missed.">	        if(StringUtil.isEmpty(sectionCode)) {</span>
<span class="nc" id="L144">	            return ErrorResponseUtil.setResponse(&quot;400&quot;, ConstantMsg.SESSION_CODE_IS_NULL);</span>
	        }
	        
//	        // 验证时间是否已添加过
//	        List&lt;Freetime&gt; freetimeList = null;
//	        try {
//	            freetimeList = freetimeService.findByFreeDateAndSectionCode(freeDate, sectionCode);
//	        }catch(Exception e){
//	            freetimeList = null;
//	        }
//	        if(freetimeList!=null){
//	            return ErrorResponseUtil.setResponse(&quot;400&quot;, ConstantMsg.FREETIME_IS_ALREADY_ADDED);
//	        }
	        
	        // 节次名字
<span class="nc" id="L159">	        Section section = sectionService.findBySectionCode(sectionCode);</span>
<span class="nc" id="L160">	        String sectionName = section.getSectionName();</span>
	        if(ConstantMsg.DEBUG) {
	        	System.out.println(sectionCode+sectionName);
	        }
	        
	        // 构造空闲时间实例
<span class="nc" id="L166">	        Date date = new Date();</span>
<span class="nc" id="L167">	        Freetime newFreetime = new Freetime();</span>

<span class="nc" id="L169">	        newFreetime.setFreeDate(freeDate);</span>
<span class="nc" id="L170">	        newFreetime.setSectionCode(sectionCode);</span>
<span class="nc" id="L171">	        newFreetime.setSectionName(sectionName);</span>
<span class="nc" id="L172">    		newFreetime.setOwnerId(this.sessionUser.getId());</span>
<span class="nc" id="L173">    		newFreetime.setOwnerName(this.sessionUser.getUserName());</span>
<span class="nc" id="L174">    		newFreetime.setFreeState(ConstantMsg.FREETIME_STATE_FREE);</span>
<span class="nc" id="L175">    		newFreetime.setReserverId(null);</span>
<span class="nc" id="L176">    		newFreetime.setReserverName(reserverName);</span>
<span class="nc" id="L177">    		newFreetime.setAllowNum(allowNum);</span>
<span class="nc" id="L178">    		newFreetime.setReservedNum(0);</span>
<span class="nc" id="L179">	        newFreetime.setFreeNote(freeNote);</span>
<span class="nc" id="L180">	        newFreetime.setReserverMsg(reserverMsg);</span>
<span class="nc" id="L181">	        newFreetime.setCreateTime(date);</span>
<span class="nc" id="L182">	        newFreetime.setUpdateTime(null);</span>
    	    
	        // 将新空闲时间写入数据库
	        try {
<span class="nc" id="L186">	            freetimeService.insert(newFreetime);</span>
<span class="nc" id="L187">	        }catch(Exception e){</span>
<span class="nc" id="L188">	            return ErrorResponseUtil.setResponse(&quot;400&quot;, e.getMessage());</span>
<span class="nc" id="L189">	        }</span>
<span class="nc" id="L190">	        return ErrorResponseUtil.setResponse(&quot;200&quot;, ConstantMsg.FREETIME_ADD_SUCCESS);</span>
	    }
	    
	    
	    /**
	     * 根据 ownerId 查看空闲时间列表
	     */
		@RequestMapping(value = &quot;/list/{ownerId}&quot;, method = RequestMethod.GET)
		private String list(@PathVariable(&quot;ownerId&quot;) String ownerId, HttpServletRequest request, Model model){
			
			// 验证参数是否合法
<span class="nc bnc" id="L201" title="All 2 branches missed.">			if(null == ownerId) {</span>
<span class="nc" id="L202">	        	model.addAttribute(&quot;errmsg&quot;, ConstantMsg.OWNER_ID_IS_NULL);</span>
<span class="nc" id="L203">	        	return &quot;freetime/list&quot;;</span>
	        }
	        
<span class="nc" id="L206">	        List&lt;Freetime&gt; freetimeList = freetimeService.findAllByOwnerId(ownerId);</span>
			
			// 验证 freetimeList 是否为空
<span class="nc bnc" id="L209" title="All 2 branches missed.">			if(null == freetimeList) {</span>
<span class="nc" id="L210">				model.addAttribute(&quot;errmsg&quot;, ConstantMsg.FREETIME_LIST_IS_NULL);</span>
<span class="nc" id="L211">	        	return &quot;freetime/list&quot;;</span>
	        }
			
			// 获取当前用户信息
<span class="nc" id="L215">			User user = SessionUtil.getUserFromSession(request);</span>
<span class="nc" id="L216">			model.addAttribute(&quot;nowUser&quot;,user);</span>
			
<span class="nc" id="L218">			model.addAttribute(&quot;freetimes&quot;,freetimeList);</span>
<span class="nc" id="L219">			return &quot;freetime/list&quot;;</span>
		}
		
		
		
		 /**
	     * 查看我发布的空闲时间
	     */
		@RequestMapping(value = &quot;/my-add&quot;, method = RequestMethod.GET)
		private String allList(HttpServletRequest request, Model model){
			
			// 验证用户是否已登录
<span class="nc bnc" id="L231" title="All 2 branches missed.">	        if(SessionUtil.isLogin(request)) {</span>
<span class="nc" id="L232">	        	this.sessionUser = SessionUtil.getUserFromSession(request);</span>
	        }else {
<span class="nc" id="L234">	        	model.addAttribute(&quot;errmsg&quot;, ConstantMsg.USER_IS_NOT_LOGIN);</span>
<span class="nc" id="L235">	        	return &quot;myspace/my-add&quot;;</span>
	        }
	        
	        // 验证用户是否有权限操作
<span class="nc bnc" id="L239" title="All 2 branches missed.">	        if(!this.sessionUser.getUserGroup().equals(ConstantMsg.USERGROUP_TEACHER)) {</span>
<span class="nc" id="L240">	        	model.addAttribute(&quot;errmsg&quot;, ConstantMsg.USER_IS_NOT_PERMITTED_TO_OOPERATE);</span>
<span class="nc" id="L241">	        	return &quot;myspace/my-add&quot;;</span>
	        }
	        
	        // 获取当前用户信息
<span class="nc" id="L245">			User user = SessionUtil.getUserFromSession(request);</span>
<span class="nc" id="L246">			model.addAttribute(&quot;nowUser&quot;,user);</span>
			
<span class="nc" id="L248">	        List&lt;Freetime&gt; freetimeList = freetimeService.findAllByOwnerId(this.sessionUser.getId());</span>
<span class="nc" id="L249">			model.addAttribute(&quot;freetimes&quot;,freetimeList);</span>
<span class="nc" id="L250">			return &quot;myspace/my-add&quot;;</span>
		}
		
		
		
		/**
	     * 查看我发布的空闲时间
	     */
		@RequestMapping(value = &quot;/my-reserve&quot;, method = RequestMethod.GET)
		private String myReserve(HttpServletRequest request, Model model){
			
			// 验证用户是否已登录
<span class="nc bnc" id="L262" title="All 2 branches missed.">	        if(SessionUtil.isLogin(request)) {</span>
<span class="nc" id="L263">	        	this.sessionUser = SessionUtil.getUserFromSession(request);</span>
	        }else {
<span class="nc" id="L265">	        	model.addAttribute(&quot;errmsg&quot;, ConstantMsg.USER_IS_NOT_LOGIN);</span>
<span class="nc" id="L266">	        	return &quot;myspace/my-reserve&quot;;</span>
	        }
	        
//	        // 验证用户是否有权限操作
//	        if(!this.sessionUser.getUserGroup().equals(ConstantMsg.USERGROUP_STUDENT)
//	        		|| !this.sessionUser.getUserGroup().equals(ConstantMsg.USERGROUP_ALU)) {
//	        	model.addAttribute(&quot;errmsg&quot;, ConstantMsg.USER_IS_NOT_PERMITTED_TO_OOPERATE);
//	        	return &quot;myspace/my-reserve&quot;;
//	        }
	        
	        // 获取当前用户信息
<span class="nc" id="L277"> 			User user = SessionUtil.getUserFromSession(request);</span>
<span class="nc" id="L278"> 			model.addAttribute(&quot;nowUser&quot;,user);</span>
	     			
<span class="nc" id="L280">	        List&lt;Freetime&gt; freetimeList = freetimeService.findAllByReserveId(this.sessionUser.getId());</span>
<span class="nc" id="L281">			model.addAttribute(&quot;freetimes&quot;,freetimeList);</span>
<span class="nc" id="L282">			return &quot;myspace/my-add&quot;;</span>
		}
		
		
		
	    /**
	     * 根据 fid 查看空闲时间详情
	     */
		@RequestMapping(value = &quot;/detail/{fid}&quot;, method = RequestMethod.GET)
		private String detail(@PathVariable(&quot;fid&quot;) String fid, HttpServletRequest request,Model model){
				
			// 验证参数是否合法
<span class="nc bnc" id="L294" title="All 2 branches missed.">			if(null == fid) {</span>
<span class="nc" id="L295">	        	model.addAttribute(&quot;errmsg&quot;, ConstantMsg.FREETIME_ID_IS_NULL);</span>
<span class="nc" id="L296">	        	return &quot;freetime/detail&quot;;</span>
	        }
			
			// 验证空闲时间是否已添加
<span class="nc" id="L300">	        Freetime freetime = null;</span>
	        try {
	        	// 根据 id 在数据库中查找空闲时间
<span class="nc" id="L303">	        	freetime= freetimeService.findById(fid);</span>
<span class="nc" id="L304">	        }catch (Exception e){</span>
	        	// 空闲时间未添加
<span class="nc" id="L306">	            freetime = null;</span>
<span class="nc" id="L307">	        }</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">	        if(null == freetime) {</span>
<span class="nc" id="L309">	        	model.addAttribute(&quot;errmsg&quot;, ConstantMsg.FREETIME_IS_NOT_ADDED);</span>
<span class="nc" id="L310">	        	return &quot;freetime/detail&quot;;</span>
	        }
	        
	        // 获取当前用户信息
<span class="nc" id="L314"> 			User user = SessionUtil.getUserFromSession(request);</span>
<span class="nc" id="L315"> 			model.addAttribute(&quot;nowUser&quot;,user);</span>
	        
<span class="nc" id="L317">			model.addAttribute(&quot;freetime&quot;,freetime);</span>
<span class="nc" id="L318">			return &quot;freetime/detail&quot;;</span>
		}
		
		
		/**
	     * 根据 fid 预约空闲时间
	     */
	    @RequestMapping(value = &quot;/reserve&quot;,method = RequestMethod.POST, produces = &quot;application/json; charset=utf-8&quot;)
	    @ResponseBody
	    public String reserveByFreetimeId(HttpServletRequest request) throws java.text.ParseException, ParseException{
	        
//	    	Map&lt;String,String&gt; response = new HashMap&lt;String,String&gt;();
//	        String result = &quot;this is result&quot;;
//			response.put(&quot;result&quot;, result);
//			response.put(&quot;errcode&quot;, &quot;200&quot;);
//			response.put(&quot;errmsg&quot;, &quot;hhaha&quot;);
//			Gson gson = new Gson();
//			return gson.toJson(response);
			
//	    	Map&lt;String,List&lt;User&gt;&gt;  response = new HashMap&lt;String,List&lt;User&gt;&gt;();
//			List&lt;User&gt; userList = userService.findByUserGroup(ConstantMsg.USERGROUP_STUDENT);
//			response.put(&quot;user1&quot;, userList);
//			Gson gson = new Gson();
//			return gson.toJson(response);
			
			
	    	// 验证用户是否已登录
<span class="nc bnc" id="L345" title="All 2 branches missed.">	        if(SessionUtil.isLogin(request)) {</span>
<span class="nc" id="L346">	        	this.sessionUser = SessionUtil.getUserFromSession(request);</span>
	        }else {
<span class="nc" id="L348">	        	return ErrorResponseUtil.setResponse(&quot;400&quot;, ConstantMsg.USER_IS_NOT_LOGIN);</span>
	        }
	        
	        // 验证用户是否有权限操作
<span class="nc bnc" id="L352" title="All 2 branches missed.">	        if(this.sessionUser.getUserGroup().equals(ConstantMsg.USERGROUP_TEACHER)) {</span>
<span class="nc" id="L353">	        	return ErrorResponseUtil.setResponse(&quot;400&quot;, ConstantMsg.USER_IS_NOT_PERMITTED_TO_OOPERATE);</span>
	        }

	        // 获取传递过来的参数
<span class="nc" id="L357">	        String fid = request.getParameter(&quot;freetimId&quot;);</span>
<span class="nc" id="L358">	        String reserverMsg = request.getParameter(&quot;reserverMsg&quot;);</span>
	      
	        // 验证参数是否合法
<span class="nc bnc" id="L361" title="All 2 branches missed.">	        if(StringUtil.isEmpty(fid)) {</span>
<span class="nc" id="L362">	            return ErrorResponseUtil.setResponse(&quot;400&quot;, ConstantMsg.FREETIME_ID_IS_NULL);</span>
	        }
	        
	        // 验证空闲时间是否已添加
	        Freetime freetime;
	        try {
	        	// 根据 id 在数据库中查找空闲时间
<span class="nc" id="L369">	        	freetime= freetimeService.findById(fid);</span>
<span class="nc" id="L370">	        }catch (Exception e){</span>
	        	// 空闲时间未添加
<span class="nc" id="L372">	            freetime = null;</span>
<span class="nc" id="L373">	        }</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">	        if(null==freetime) {</span>
<span class="nc" id="L375">	        	return ErrorResponseUtil.setResponse(&quot;400&quot;, ConstantMsg.FREETIME_IS_NOT_ADDED);</span>
	        }
	        
	        // 预约人数已满
<span class="nc bnc" id="L379" title="All 2 branches missed.">	        if(freetime.getFreeState().equals(ConstantMsg.FREETIME_STATE_BUSY)) {</span>
<span class="nc" id="L380">	        	return ErrorResponseUtil.setResponse(&quot;400&quot;, ConstantMsg.USER_RESERVE_NUM_IS_FULL);</span>
	        }
	        
	        // 更新预约人数
<span class="nc" id="L384">	        int reservedNum = freetime.getReservedNum() + 1;</span>
<span class="nc" id="L385">	        freetime.setReservedNum(reservedNum);</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">	        if(freetime.getReservedNum()&gt;=freetime.getAllowNum()) {</span>
<span class="nc" id="L387">	        	freetime.setFreeState(ConstantMsg.FREETIME_STATE_BUSY);</span>
	        }
	        
	        // 将 session 里的 user id 添加到预约人 reserverId
<span class="nc" id="L391">	        String reserverId = this.sessionUser.getId();</span>
<span class="nc" id="L392">	        freetime.setReserverId(reserverId);</span>
	        // 将 session 里的 userName 添加到预约人 reserverName
<span class="nc" id="L394">	        String reserverName = this.sessionUser.getUserName();</span>
<span class="nc" id="L395">	        freetime.setReserverName(reserverName);</span>
	        // 更新预约时的时间
<span class="nc" id="L397">	        Date updateTime = new Date();</span>
<span class="nc" id="L398">	        freetime.setUpdateTime(updateTime);</span>
	        // 更新留言
<span class="nc" id="L400">	        freetime.setReserverMsg(reserverMsg);</span>
	        // 更新状态
<span class="nc" id="L402">	        freetime.setFreeState(ConstantMsg.FREETIME_STATE_RESERVED);</span>
	        
	        
<span class="nc" id="L405">	        List&lt;Freetime&gt; freetimeList = null;</span>
<span class="nc" id="L406">            freetimeList = freetimeService.findByFreeDateAndSectionCode(freetime.getFreeDate(), freetime.getSectionCode());</span>
<span class="nc bnc" id="L407" title="All 4 branches missed.">            if(freetimeList.size()==1 &amp;&amp; freetimeList.get(0).getFreeState()==ConstantMsg.FREETIME_STATE_FREE) {</span>
            	// 没有预约者时更新空闲时间 
<span class="nc" id="L409">            	freetimeService.update(freetime);</span>
<span class="nc" id="L410">                return ErrorResponseUtil.setResponse(&quot;200&quot;, ConstantMsg.USER_RESERVE_SUCCESS);</span>
            }else {
            	// 有一位及以上预约者时
            	Freetime ft;
//            	for(int i=0; i &lt; freetimeList.size(); i++) {
//            		
//            		ft=freetimeList.get(i);
//            		// 此用户已预约过
//        	        if(ft.getReserverId().equals(sessionUser.getId())) {
//        	        	 return ErrorResponseUtil.setResponse(&quot;400&quot;, ConstantMsg.USER_ALREADY_RESERVED);
//        	        }
//            	}
            	// 更新所有旧空闲时间的已预约人数
<span class="nc bnc" id="L423" title="All 2 branches missed.">            	for(int i=0; i &lt; freetimeList.size(); i++) {</span>
            		
<span class="nc" id="L425">            		ft=freetimeList.get(i);</span>
            		// 预约人数已满
<span class="nc bnc" id="L427" title="All 2 branches missed.">        	        if(ft.getFreeState().equals(ConstantMsg.FREETIME_STATE_BUSY)) {</span>
<span class="nc" id="L428">        	        	continue;</span>
        	        }
        	        // 更新预约人数
<span class="nc" id="L431">        	        ft.setReservedNum(reservedNum);</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">        	        if(ft.getReservedNum()&gt;=ft.getAllowNum()) {</span>
<span class="nc" id="L433">        	        	ft.setFreeState(ConstantMsg.FREETIME_STATE_BUSY);</span>
        	        }
<span class="nc" id="L435">            		freetimeService.update(ft);</span>
            	}
            	// 插入新空闲时间 
//            	try {
<span class="nc" id="L439">            		int ftid = freetimeService.findAll().size()+1;</span>
<span class="nc" id="L440">            		freetime.setId(ftid+&quot;&quot;);</span>
<span class="nc" id="L441">                    freetimeService.insert(freetime);</span>
//                 }catch(Exception e){
//                     return ErrorResponseUtil.setResponse(&quot;400&quot;, e.getMessage());
//                 }
            }
            
           
<span class="nc" id="L448">            return ErrorResponseUtil.setResponse(&quot;400&quot;, ConstantMsg.USER_RESERVE_SUCCESS);</span>
	    }

	    

		/**
	     * 根据id删除空闲时间
	     */
	    @RequestMapping(value = &quot;/delete&quot;, method = RequestMethod.GET)
	    public String deleteById(HttpServletRequest request, Model model) {
	    	
			// 验证用户是否已登录
<span class="nc bnc" id="L460" title="All 2 branches missed.">	        if(SessionUtil.isLogin(request)) {</span>
<span class="nc" id="L461">	        	this.sessionUser = SessionUtil.getUserFromSession(request);</span>
	        }else {
<span class="nc" id="L463">	        	model.addAttribute(&quot;errmsg&quot;, ConstantMsg.USER_IS_NOT_LOGIN);</span>
<span class="nc" id="L464">	        	return &quot;myspace/my-add&quot;;</span>
	        }
	        
	        // 验证参数是否合法
<span class="nc" id="L468">	        String fid = request.getParameter(&quot;fid&quot;);</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">			if(null == fid) {</span>
<span class="nc" id="L470">	            return ErrorResponseUtil.setResponse(&quot;400&quot;, ConstantMsg.OWNER_ID_IS_NULL);</span>
	        }
			
			// 验证空闲时间是否已添加
<span class="nc" id="L474">	        Freetime freetime = null;</span>
	        try {
	        	// 根据 id 在数据库中查找空闲时间
<span class="nc" id="L477">	        	freetime= freetimeService.findById(fid);</span>
<span class="nc" id="L478">	        }catch (Exception e){</span>
	        	// 空闲时间未添加
<span class="nc" id="L480">	            freetime = null;</span>
<span class="nc" id="L481">	        }</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">	        if(null == freetime) {</span>
<span class="nc" id="L483">	        	model.addAttribute(&quot;errmsg&quot;, ConstantMsg.FREETIME_IS_NOT_ADDED);</span>
<span class="nc" id="L484">	        	return &quot;myspace/my-add&quot;;</span>
	        }
	        
	        // 验证用户是否有权限操作
<span class="nc bnc" id="L488" title="All 2 branches missed.">	        if(!this.sessionUser.getUserGroup().equals(ConstantMsg.USERGROUP_TEACHER)</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">	        		||!this.sessionUser.getId().equals(freetime.getOwnerId())) {</span>
<span class="nc" id="L490">	        	return ErrorResponseUtil.setResponse(&quot;400&quot;, ConstantMsg.USER_IS_NOT_PERMITTED_TO_OOPERATE);</span>
	        }
			
<span class="nc" id="L493">	        freetimeService.delete(fid);</span>
<span class="nc" id="L494">	        List&lt;Freetime&gt; freetimeList = freetimeService.findAllByOwnerId(this.sessionUser.getId());</span>
	        
	        // 获取当前用户信息
<span class="nc" id="L497"> 			User user = SessionUtil.getUserFromSession(request);</span>
<span class="nc" id="L498"> 			model.addAttribute(&quot;nowUser&quot;,user);</span>
 			
<span class="nc" id="L500">			model.addAttribute(&quot;freetimes&quot;,freetimeList);</span>
<span class="nc" id="L501">			return &quot;myspace/my-add&quot;;</span>
	    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>